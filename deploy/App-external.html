<!DOCTYPE html>
<html>
<head>
    <title>S485020-SafeAdherence</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_iterationMap:void 0,_iterationAcceptedMap:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"vbox"},height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,this._initDate,this._endDate)}});this.down("#header").add([{xtype:"panel",autoWidth:!0,height:180,layout:"hbox",items:[{xtype:"panel",title:"Choose date range:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,a){this._initDate=t.toISOString()},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,a){this._endDate=t},scope:this}},t]}]}])},_doSearch:function(e,t,a){this.myMask.show(),this._getIterations(e,t,a)},_getIterations:function(e,t,a){Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,fetch:["Description","Name","ObjectID","PlannedVelocity","StartDate","EndDate","Project"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.and([Rally.data.QueryFilter.or([{property:"Project.parent.ObjectID",value:e},{property:"Project.parent.parent.ObjectID",value:e}]),Rally.data.QueryFilter.and([{property:"StartDate",operator:">=",value:t},{property:"EndDate",operator:"<=",value:a}])]),listeners:{load:function(e,t,a){var o=[],i=[];this._iterationMap=new Ext.util.MixedCollection,this._iterationAcceptedMap=new Ext.util.MixedCollection,_.each(t,function(e){this._iterationMap.add(e.get("ObjectID"),e),o.push(this._getStoriesByIteration(e)),i.push(this._getStoriesAcceptedOnDate(e))},this),Deft.Promise.all(i).then({success:function(e){_.each(e,function(e){if(e.length>0){var t=e[0].get("Iteration").ObjectID,a=this._iterationMap.get(t).get("EndDate");this._iterationAcceptedMap.add(t,this._calculateAcceptedScore(e,a))}},this),console.log("Accepted map:",this._iterationAcceptedMap)},scope:this}),Deft.Promise.all(o).then({success:function(e){var t=[];_.each(e,function(e){e.length>0&&t.push(this._calculateVelocity(e))},this),this._createGrid(t)},scope:this})},scope:this}})},_getStoriesByIteration:function(e){var t=Ext.create("Deft.Deferred"),a=e.get("ObjectID"),o=[{property:"__At",value:e.get("EndDate")},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement"]},{property:"_ProjectHierarchy",value:e.get("Project").ObjectID},{property:"Iteration",value:a}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","PlanEstimate","ScheduleState","State","Project","Iteration","_ValidFrom","_ValidTo"],filters:o,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","Iteration","ScheduleState","Project"],listeners:{load:function(e,a,o){t.resolve(a)},scope:this}});return t.promise},_getStoriesAcceptedOnDate:function(e){var t=e.get("ObjectID"),a=(new Ext.util.MixedCollection,Ext.create("Deft.Deferred"));return Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,fetch:["Name","ObjectID","FormattedID","AcceptedDate","Iteration"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"Iteration.ObjectID",value:t}],limit:1/0,listeners:{load:function(e,t,o){a.resolve(t)}},scope:this}),a.promise},_calculateVelocity:function(e){var t={};if(e&&e.length>0){var a=0;_.each(e,function(e){"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")||(a+=e.get("PlanEstimate"))},this);var o,i=e[0].get("Iteration").Name,n=e[0].get("Iteration").ObjectID,r=this._iterationMap.get(n).get("PlannedVelocity");o=r?Math.round(a/r*100)+"%":"PlannedVelocity empty";var c=this._calculateScore(a,r),l=this._iterationAcceptedMap.get(n);t={iteration:i,iterationId:n,project:e[0].get("Project").Name,actualVelocity:a,plannedVelocity:r,percentDone:o,score:c,acceptedScore:l}}return t},_calculateScore:function(e,t){if(!t)return 0;var a=Math.round(e/t*100);return a>=100?5:a>=90?4:a>=80?3:a>=70?2:0},_calculateAcceptedScore:function(e,t){var a=0;return _.each(e,function(e){this._isAcceptedWithinRange(e,t)&&(a+=1)},this),a>e.length/2?5:0},_isAcceptedWithinRange:function(e,t){var a=new Date(t.getFullYear(),t.getMonth(),t.getDate()-2);return!(e.get("AcceptedDate")>a)},_createGrid:function(e){this.down("#bodyContainer").removeAll(!0);var t=Ext.create("Rally.data.custom.Store",{data:e,pageSize:1e3}),a=Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var t=this._convertToCSV(e);console.log("converting to csv:",t);var a=document.createElement("a"),o=new Blob(["\ufeff",t]),i=URL.createObjectURL(o);a.href=i,a.download="report.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}),o=Ext.create("Rally.ui.grid.Grid",{width:880,viewConfig:{stripeRows:!0,enableTextSelection:!0},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"iterationScoreGrid",store:t,columnCfgs:[{text:"Iteration",dataIndex:"iteration",flex:2},{text:"Project",dataIndex:"project",flex:3},{text:"Percent Done",dataIndex:"percentDone",flex:1},{text:"Velocity Score",dataIndex:"score",flex:1},{text:"PO Engaged",dataIndex:"acceptedScore",flex:1}]}),i=Ext.create("Ext.panel.Panel",{title:"Iteration Adherence Score",autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,items:[o]});this.down("#bodyContainer").add(a),this.down("#bodyContainer").add(i),this.myMask.hide()},_convertToCSV:function(e){var t=Object.keys(e[0]),a=function(e,t){return null===t?"":t},o=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],a)}).join(",")});return o.unshift(t.join(",")),o.join("\r\n")}});

            Rally.launchApp('CustomApp', {
                name:"S485020-SafeAdherence",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
