<!DOCTYPE html>
<html>
<head>
    <title>S485020-SafeAdherence</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_iterationMap:void 0,_iterationAcceptedMap:void 0,_iterationBlockedMap:void 0,_iterationTestCaseMap:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"vbox"},height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,this._initDate,this._endDate)}});this.down("#header").add([{xtype:"panel",autoWidth:!0,height:180,layout:"hbox",items:[{xtype:"panel",title:"Choose date range:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,a){this._initDate=t.toISOString()},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,a){this._endDate=t},scope:this}},t]}]}])},_doSearch:function(e,t,a){this.myMask.show(),this._getIterations(e,t,a)},_getIterations:function(e,t,a){Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,fetch:["Description","Name","ObjectID","PlannedVelocity","StartDate","EndDate","Project","Theme","Notes","c_RetroActions","c_RetroDeltas","c_RetroPluses"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.and([Rally.data.QueryFilter.or([{property:"Project.parent.ObjectID",value:e},{property:"Project.parent.parent.ObjectID",value:e}]),Rally.data.QueryFilter.and([{property:"StartDate",operator:">=",value:t},{property:"EndDate",operator:"<=",value:a}])]),listeners:{load:function(e,t,a){console.log("Iterations:",t);var o=[],r=[];this._iterationMap=new Ext.util.MixedCollection,this._iterationAcceptedMap=new Ext.util.MixedCollection,this._iterationBlockedMap=new Ext.util.MixedCollection,this._iterationTestCaseMap=new Ext.util.MixedCollection,_.each(t,function(e){this._iterationMap.add(e.get("ObjectID"),e),o.push(this._getStoriesByIteration(e)),r.push(this._getStoriesAcceptedOnDate(e))},this);var i=this._fetchSayDoFromLookback(t);Deft.Promise.all(r).then({success:function(e){_.each(e,function(e){if(e.length>0){var t=e[0].get("Iteration").ObjectID,a=this._iterationMap.get(t).get("EndDate");this._iterationAcceptedMap.add(t,this._calculateAcceptedScore(e,a)),this._iterationTestCaseMap.add(t,this._calculateTestCasesAcceptance(e))}},this),console.log("Accepted map:",this._iterationAcceptedMap),console.log("TestCase map:",this._iterationTestCaseMap),Deft.Promise.all(o).then({success:function(e){var t=[];_.each(e,function(e){e.length>0&&t.push(this._calculateVelocity(e))},this);var a=[];_.each(e,function(e){a.push(this._calculateAverageBlocked(e))},this),i.then({success:function(e){console.log("end of sayDo promises:",e),_.each(t,function(t){var a=Math.round(100*e[t.iterationId].count_ratio)+"%",o=this._calculateDeliveryScore(e[t.iterationId].count_ratio);t.sayDoRatio=a,t.deliveryScore=o},this)},scope:this}),Deft.Promise.all(a).then({success:function(e){this._iterationBlockedMap.eachKey(function(e,a){_.each(t,function(t){t.iterationId==e&&(t.daysBlocked=a.totalBlocked,t.averageDaysBlocked=a.averageDaysBlocked,t.blockedAgingScore=a.blockedAgingScore)},this)},this),console.log("final rows:",t),this._createGrid(t)},scope:this})},scope:this})},scope:this})},scope:this}})},_calculateAverageBlocked:function(e){var t=Ext.create("Deft.Deferred"),a=[];if(e.length>0){var o=e[0].get("Iteration").ObjectID;_.each(e,function(e){a.push(this._getDaysBlocked(e))},this),Deft.Promise.all(a).then({success:function(e){console.log("end of calculate average:",e);var a=0;_.each(e,function(e){a+=e},this);var r=Math.floor(a/e.length),i=0;switch(r){case 0:case 1:i=5;break;case 2:i=4;break;case 3:i=3;break;case 4:i=1;break;case 5:i=0;break;default:i=0}var c={iterationId:o,totalBlocked:a,averageDaysBlocked:r,blockedAgingScore:i};this._iterationBlockedMap.add(o,c),t.resolve(c)},scope:this})}else t.resolve();return t.promise},_getDaysBlocked:function(e){var t=Ext.create("Deft.Deferred"),a=[{property:"_TypeHierarchy",operator:"in",value:["HierarchicalRequirement","Defect","TestSet"]},{property:"ObjectID",value:e.get("ObjectID")},{property:"_ValidTo",operator:"<=",value:e.get("_ValidTo")}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","Project","Blocked","Iteration","_ValidFrom","_ValidTo"],filters:a,autoLoad:!0,sorters:[{property:"_ValidTo",direction:"ASC"}],limit:1/0,compress:!0,hydrate:["Iteration","Project"],listeners:{load:function(e,a,o){var r=this._calculateDaysBlocked(a);t.resolve(r)},scope:this}});return t.promise},_calculateDaysBlocked:function(e){for(var t,a,o=0,r=0;r<e.length;r++){var i=e[r];if(i.get("Blocked")){!0;var c=i.get("_ValidFrom"),n=i.get("_ValidTo"),s=new Date;t=new Date(c),o+=(a=new Date(n))>s?this._getDifferenceInMilis(t,s):this._getDifferenceInMilis(t,a)}}return Math.floor(o/864e5)},_calculateDeliveryScore:function(e){return e>=.9?5:e>=.8?3:0},_getDifferenceInMilis:function(e,t){var a=new Date(e).getTime();return new Date(t).getTime()-a},_getStoriesByIteration:function(e){var t=Ext.create("Deft.Deferred"),a=e.get("ObjectID"),o=e.get("EndDate"),r=e.get("Project").ObjectID;this._showStatus("Loading Stories for iteration:"+a);var i=[{property:"__At",value:o},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement","TestSet"]},{property:"_ProjectHierarchy",value:r},{property:"Iteration",value:a}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","PlanEstimate","ScheduleState","State","Project","Iteration","_ValidFrom","_ValidTo"],filters:i,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","Iteration","ScheduleState","Project"],listeners:{load:function(e,a,o){t.resolve(a),console.log("stories data",a)},scope:this}});return t.promise},_getStoriesAcceptedOnDate:function(e){var t=e.get("ObjectID");this._showStatus("Loading Stories for Checking engaging of PO.");var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:["Defect","UserStory","TestSet"],autoLoad:!0,fetch:["Name","ObjectID","FormattedID","AcceptedDate","Iteration","TestCases","InProgressDate"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"Iteration.ObjectID",value:t}],limit:1/0,listeners:{load:function(e,t,o){var r=[];t&&t.length>0?(_.each(t,function(e){var t=e.getCollection("TestCases"),a=t.load({fetch:["FormattedID","Name","CreationDate"]});r.push(a),e.testCasesStore=t},this),Deft.Promise.all(r).then({success:function(e){a.resolve(t)},scope:this})):a.resolve(t)}},scope:this}),a.promise},_calculateVelocity:function(e){var t={};if(e&&e.length>0){var a=0;_.each(e,function(e){"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")||(a+=e.get("PlanEstimate"))},this);var o,r=e[0].get("Iteration").Name,i=e[0].get("Iteration").ObjectID,c=this._iterationMap.get(i).get("PlannedVelocity"),n=this._calculateObjectivesScore(i),s=this._calculateExternalDeltasScore(i),l=this._calculateRetrospectivesScore(i);o=c?Math.round(a/c*100)+"%":"PlannedVelocity empty";var d=this._calculateVelocityScore(a,c),u=this._iterationAcceptedMap.get(i),h=this._iterationTestCaseMap.get(i);t={iteration:r,iterationId:i,project:e[0].get("Project").Name,actualVelocity:a,plannedVelocity:c,percentDone:o,velocityScore:d,acceptedScore:u,objectivesScore:n,externalDeltasScore:s,retrospectivesScore:l,testCaseScore:h}}return t},_calculateTestCasesAcceptance:function(e){var t=0;return e&&e.length>0&&_.each(e,function(e){var a=e.get("InProgressDate");e.testCasesStore.data.eachKey(function(e,o){o.get("CreationDate")<a&&(t=5)},this)},this),t},_calculateObjectivesScore:function(e){return this._iterationMap.get(e).get("Theme")?5:0},_calculateExternalDeltasScore:function(e){return this._iterationMap.get(e).get("Notes")?5:0},_calculateRetrospectivesScore:function(e){var t=this._iterationMap.get(e).get("c_RetroPluses"),a=this._iterationMap.get(e).get("c_RetroActions"),o=this._iterationMap.get(e).get("c_RetroDeltas");return t&&a&&o?5:0},_calculateVelocityScore:function(e,t){if(!t)return 0;var a=Math.round(e/t*100);return a>=100?5:a>=90?4:a>=80?3:a>=70?2:0},_calculateAcceptedScore:function(e,t){var a=0;return _.each(e,function(e){this._isAcceptedWithinRange(e,t)&&(a+=1)},this),a>e.length/2?5:0},_isAcceptedWithinRange:function(e,t){var a=new Date(t.getFullYear(),t.getMonth(),t.getDate()-2);return!(e.get("AcceptedDate")>a)},_showStatus:function(e){e?Rally.ui.notify.Notifier.showStatus({message:e,showForever:!1,closable:!1,animateShowHide:!1}):Rally.ui.notify.Notifier.hide()},_fetchSayDoFromLookback:function(e){var t=this,a=Ext.create("Deft.Deferred");if(0===e.length)return[];this._showStatus("Loading Iteration Say/Do Data");var o=[];return Ext.Array.each(e,function(e){var a=new Date(e.get("StartDate").setHours(23,59,59)),r=e.get("EndDate"),i=e.get("ObjectID");o.push(function(){return t._fetchSayDoForIteration(i,a,r)})}),Deft.Chain.sequence(o,t).then({success:function(e){var t={};Ext.Array.each(e,function(e){Ext.Object.merge(t,e)}),console.log("say do ratio by iteration:",t),a.resolve(t)},failure:function(e){a.reject(e)}}),a.promise},_fetchSayDoForIteration:function(e,t,a){var o=this,r=Ext.create("Deft.Deferred"),i=[function(){return o._fetchSayDoForStartOfIteration(e,t,a)},function(){return o._fetchSayDoForEndOfIteration(e,t,a)}];return Deft.Chain.sequence(i,o).then({success:function(t){var a=t[0],o=t[1],i={},c=0,n=0;Ext.Array.each(a,function(e){var t=e.get("FormattedID"),a=e.get("PlanEstimate")||0;i[t]=e,c+=1,n+=a});var s={items:[],count_start:c,size_start:n,count_end:0,size_end:0,count_ratio:-1,size_ratio:-1};Ext.Array.each(o,function(e){var t=e.get("FormattedID"),a=i[t];if(Ext.isEmpty(a))console.log("Not in the start: ",t);else if(Ext.isEmpty(e.get("AcceptedDate")))console.log("Not Accepted: ",t);else{a.set("__end_plan_estimate",o);var o=a.get("PlanEstimate")||0;s.count_end=s.count_end+1,s.size_end=s.size_end+o}}),s.items=Ext.Array.map(Ext.Object.getValues(i),function(e){return e}),s.count_start>0&&(s.count_ratio=s.count_end/s.count_start),s.size_start>0&&(s.size_ratio=s.size_end/s.size_start);var l={};l[e]=s,r.resolve(l)},failure:function(e){r.reject(e)}}),r.promise},_fetchSayDoForStartOfIteration:function(e,t,a){var o=Rally.data.lookback.QueryFilter.or([{property:"__At",value:Rally.util.DateTime.toIsoString(t)}]),r=Rally.data.lookback.QueryFilter.and([{property:"Iteration",value:e}]),i={fetch:["FormattedID","Name","AcceptedDate","PlanEstimate"],filters:o.and(r)};return this._fetchData("Rally.data.lookback.SnapshotStore",i)},_fetchSayDoForEndOfIteration:function(e,t,a){var o=Rally.data.lookback.QueryFilter.or([{property:"__At",value:Rally.util.DateTime.toIsoString(a)}]),r=Rally.data.lookback.QueryFilter.and([{property:"Iteration",value:e}]),i={fetch:["FormattedID","Name","AcceptedDate","PlanEstimate"],filters:o.and(r)};return this._fetchData("Rally.data.lookback.SnapshotStore",i)},_fetchData:function(e,t){var a=Ext.create("Deft.Deferred");return Ext.create(e,t).load({callback:function(e,t){t.wasSuccessful()?a.resolve(e):a.resolve("Error fetching data: "+t.error.errors.join(","))},scope:this}),a},_createGrid:function(e){this.down("#bodyContainer").removeAll(!0);var t=Ext.create("Rally.data.custom.Store",{data:e,pageSize:1e3}),a=Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var t=this._convertToCSV(e);console.log("converting to csv:",t);var a=document.createElement("a"),o=new Blob(["\ufeff",t]),r=URL.createObjectURL(o);a.href=r,a.download="report.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}),o=Ext.create("Rally.ui.grid.Grid",{width:1600,viewConfig:{stripeRows:!0,enableTextSelection:!0},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"iterationScoreGrid",store:t,columnCfgs:[{text:"Iteration",dataIndex:"iteration",flex:2},{text:"Project",dataIndex:"project",flex:3},{text:"Percent Done",dataIndex:"percentDone",flex:1},{text:"Velocity Score",dataIndex:"velocityScore",flex:1},{text:"PO Engaged",dataIndex:"acceptedScore",flex:1},{text:"Days Blocked",dataIndex:"daysBlocked",flex:2},{text:"Average Days Blocked",dataIndex:"averageDaysBlocked",flex:2},{text:"Blocked Aging Score",dataIndex:"blockedAgingScore",flex:2},{text:"Objectives Score",dataIndex:"objectivesScore",flex:2},{text:"External Deltas Score",dataIndex:"externalDeltasScore",flex:2},{text:"Retrospectives Score",dataIndex:"retrospectivesScore",flex:2},{text:"TestCase Score",dataIndex:"testCaseScore",flex:2},{text:"Say Do Ratio",dataIndex:"sayDoRatio",flex:2},{text:"Delivery Score",dataIndex:"deliveryScore",flex:2}]}),r=Ext.create("Ext.panel.Panel",{title:"Iteration Adherence Score",autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,items:[o]});this.down("#bodyContainer").add(a),this.down("#bodyContainer").add(r),this.myMask.hide()},_convertToCSV:function(e){var t=Object.keys(e[0]),a=function(e,t){return null===t?"":t},o=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],a)}).join(",")});return o.unshift(t.join(",")),o.join("\r\n")}});

            Rally.launchApp('CustomApp', {
                name:"S485020-SafeAdherence",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
